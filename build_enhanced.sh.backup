#!/bin/bash

# FlowIntelligence å¢å¼ºç‰ˆæ„å»ºè„šæœ¬
# åŒ…å«æ‰€æœ‰æ–°çš„ä¼˜åŒ–ç»„ä»¶

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ğŸš€ å¼€å§‹æ„å»º FlowIntelligence å¢å¼ºç‰ˆ..."

# åˆ›å»ºæ„å»ºç›®å½•
BUILD_DIR="build_enhanced"
if [ -d "$BUILD_DIR" ]; then
    echo "ğŸ§¹ æ¸…ç†ç°æœ‰æ„å»ºç›®å½•..."
    rm -rf "$BUILD_DIR"
fi

mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

echo "âš™ï¸  é…ç½® CMake..."

# æ£€æŸ¥æ˜¯å¦æœ‰ CUDA æ”¯æŒ
if command -v nvcc &> /dev/null; then
    echo "âœ… æ£€æµ‹åˆ° CUDAï¼Œå¯ç”¨ GPU åŠ é€Ÿ"
    CUDA_OPTION="-DENABLE_CUDA=ON"
else
    echo "âš ï¸  æœªæ£€æµ‹åˆ° CUDAï¼Œç¦ç”¨ GPU åŠ é€Ÿ"
    CUDA_OPTION="-DENABLE_CUDA=OFF"
fi

# é…ç½® CMake
cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DENABLE_OPENMP=ON \
    -DENABLE_SIMD=ON \
    -DBUILD_EXAMPLES=ON \
    -DBUILD_TESTS=ON \
    $CUDA_OPTION

echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."

# å¹¶è¡Œç¼–è¯‘
NPROC=$(nproc 2>/dev/null || echo 4)
make -j$NPROC

echo "ğŸ¯ æ„å»ºå®Œæˆ!"

# æ˜¾ç¤ºæ„å»ºç»“æœ
echo ""
echo "ğŸ“‹ æ„å»ºç»“æœ:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f "FlowIntelligence" ]; then
    echo "âœ… FlowIntelligence (åŸç‰ˆ)"
    ls -lh FlowIntelligence
fi

if [ -f "FlowIntelligenceEnhanced" ]; then
    echo "âœ… FlowIntelligenceEnhanced (å¢å¼ºç‰ˆ)"
    ls -lh FlowIntelligenceEnhanced
fi

if [ -f "libFlowIntelligenceCore.a" ]; then
    echo "âœ… FlowIntelligenceCore (æ ¸å¿ƒåº“)"
    ls -lh libFlowIntelligenceCore.a
fi

# æ£€æŸ¥æµ‹è¯•ç¨‹åº
if [ -f "UnitTests" ]; then
    echo "âœ… UnitTests (å•å…ƒæµ‹è¯•)"
    ls -lh UnitTests
fi

if [ -f "IntegrationTests" ]; then
    echo "âœ… IntegrationTests (é›†æˆæµ‹è¯•)"
    ls -lh IntegrationTests
fi

echo ""
echo "ğŸš€ å¯ä»¥è¿è¡Œä»¥ä¸‹ç¨‹åº:"
echo "  ./FlowIntelligence                  # åŸç‰ˆè§†é¢‘åŒ¹é…"
echo "  ./FlowIntelligenceEnhanced         # å¢å¼ºç‰ˆè§†é¢‘åŒ¹é…"
echo "  ./UnitTests                        # è¿è¡Œå•å…ƒæµ‹è¯•"
echo "  ./IntegrationTests                 # è¿è¡Œé›†æˆæµ‹è¯•"

# å¯é€‰ï¼šè¿è¡Œå¿«é€Ÿæµ‹è¯•
echo ""
read -p "æ˜¯å¦è¿è¡Œé›†æˆæµ‹è¯•éªŒè¯æ„å»ºç»“æœ? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
    if [ -f "IntegrationTests" ]; then
        ./IntegrationTests
    else
        echo "âŒ é›†æˆæµ‹è¯•ç¨‹åºæœªæ‰¾åˆ°"
    fi
fi

echo ""
echo "ğŸ‰ FlowIntelligence å¢å¼ºç‰ˆæ„å»ºå®Œæˆ!"
echo "   ä½ç½®: $(pwd)"
